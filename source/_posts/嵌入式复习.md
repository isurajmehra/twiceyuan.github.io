title: 嵌入式复习
tags:
  - 嵌入式
date: 2015-06-08 22:28:46
---

## 嵌入式系统

### 嵌入式系统定义

嵌入式系统是以应用为中心、以计算机技术为基础、软件硬件可剪裁，适应应用系统对功能、可靠性、成本、体积、功耗严格要求的专用计算机系统。

<!--more-->

### 嵌入式系统特点

上课讲：嵌入式专用、综合性强、设计高效、程序固化、需要独立的开发系统、生命周期长、可靠性高、低功效。
书上：专用性、系统精简、低功耗、实时性、可靠性、技术融合、开发工具和环境。

## ARM 核

### 寄存器组

31个通用寄存器和6个状态寄存器

#### 通用寄存器

1.  不分组寄存器R0~R7

    在所有处理器模式下，它们每一个都访问的是同一个物理寄存器，是真正并且在每种状态下都统一的通用寄存器。

2.  分组寄存器R8~R14

    所对应的物理寄存器取决于当前的处理器模式
R8~R12有两个分组的物理寄存器。一组用于除FIQ模式之外的所有模式，一组用于FIQ模式。
R13常用作堆栈指针，称作SP。
R14用作子程序链接寄存器，也称LR。在每种处理器模式下，模式自身的R14用于保存子程序返回地址。当发生异常时，该模式下对应的R14被设置为异常返回地址。

3.  R15用作程序计数器，也称PC。由于ARM处理器采用流水线机制，当正确读取pc时，该值为当前指令地址加8字节。即pc指向当前指令的下两条指令的地址。

#### 程序状态寄存器

CPSR当前程序状态寄存器，SPSR程序状态备份寄存器。特定的异常发生时，SPSR用于保存CPSR的当前值，在异常中断程序退出时，可以用SPSR中保存的值来恢复CPSR。
功能：保存ALU当前操作信息、控制允许和禁止中断、设置处理器运行模式

### 工作状态及运行模式

两种工作状态：ARM、Thumb

七种运行模式：用户模式User、快速中断模式FIQ、外部中断模式IRQ、管理模式svc、数据访问终止模式abt、未定义指令终止模式und、系统模式sys。（除了用户模式，其他都属于特权模式）

### 异常响应过程

1）将下一条指令的地址存入响应的异常模式的链接寄存器LR，以便程序在处理异常返回时能从正确位置重新开始执行。

2）复制CPSR寄存器的内容至对应模式下的SPSR_<mode>寄存器中。</mode>

3）对CPSR寄存器的一些控制位进行设置：无论发生异常时处理器处于Thumb状态还是ARM状态，响应异常后处理器都会切换到ARM状态，即CPSR[5]=0；将模式控制位CPSR[4:0]设置为被响应异常的模式编码；CPSR[7]=1,禁止IRQ中断；如果异常模式为复位模式或FIQ模式，则CPSR[6]=1,禁止FIQ中断。

4）将程序计数器（PC）设置为异常向量的地址，使程序从相应的异常向量地址开始执行异常处理程序。一般来说，向量地址处将包含一条指向相应异常处理程序的转移指令，从而可以跳转到相应异常处理程序处。

### 寻址方式

立即寻址、寄存器寻址、寄存器间接寻址、寄存器移位寻址、基址加变址寻址、块拷贝寻址、堆栈寻址、相对寻址

1.  立即寻址：MOV  R1 , #0x10 ;        #号开始表示立即数

2.  寄存器寻址：MOV  R1 , R2;          寄存器中的数值即为操作数

3.  寄存器间接寻址：STR  R0 , [R1];
LDR  R0 , [R1];        寄存器中的数值即为操作数的地址

4.  寄存器移位寻址：MOV R0,R1,LSL # 2;   注：LSL：逻辑左移 LSR：逻辑右移  ASL：算术左移 ASR：算术右移  ROR：循环右移 RRX：带扩展循环右移
5.  基址加变址寻址：将寄存器的内容与指令中给出的地址偏移量相加，从而得到一个操作数的有效地址。
前变址法：LDR  R0,[R1,#4];   R1加偏移量4形成操作数地址，取出操作数存入R0。
后变址法：LDR  R0，[ R1],#4;    R1的值作为操作数的有效地址，取出操作数存入R0，将R1的内容加4来更新基址寄存器。

6.  块拷贝：也叫做多寄存器寻址。快拷贝的地址变化方式：后增IA、先增IB、后减DA、先减DB。    STMIA  R0,{R1-R3,R8};
解释： [R0]&lt;—R1  [R0+4]&lt;-R2    [R0+8]&lt;-R3  [R0+12]&lt;-R8

7.  堆栈寻址：堆栈的分类：满堆栈、空堆栈、递增堆栈、递减堆栈、满递增堆栈、满递减堆栈、空递增堆栈、空递减堆栈。   STMFD  SP！，{R1-R3，R8}；

8.  相对寻址：以程序计数器PC的当前值为基地址，指令中的地址标号作为偏移量，相加后的地址即为操作数的有效地址。

BL  SUB1;
…
SUB1:
….
MOV  PC,LR；

### 指令系统

#### 单寄存器传送指令LDR和STR指令

1.  LDR：加载字数据

    从内存中将一个32位的字数据或一个8位的字节数据读取至寄存器中。

     LDR {cond}{T}  Rd，addressing;加载指定存储单元中的32位字数据到寄存器Rd。

2.  STR：存储字数据

    将一个32位的寄存器中的字数据或一个寄存器的低8位写入到指令指定的内存单元中。 STR {cond}{T}  Rd，addressing; 存储Rd中的字数据到指定的存储单元中。
多寄存器传送LDM和STM指令：  （用途：保护现场、数据复制、参数传递等）

3.  LDM：多寄存器加载

    将连续内存单元数据加载到若干个寄存器中。

    LDMIA  R1！，{R5-R7}；加载R1指向的存储区域的多字数据至R5-R7中

4.  STM：多寄存器存储

    将若干个寄存器的值放到连续的内存单元中。

    STMIA R0！，{R5-R7}；将R5-R7的数据存储到R0指向的存储区域，R0更新

    程序状态寄存器访问指令：   (只有特权模式下可以修改状态寄存器)

5.  MRS：读状态存储器

MRS指令用于将状态寄存器的内容传送到通用寄存器中。这是程序获得程序状态寄存器PSR值得唯一方法；

MRS  R0，CPSR；   读取CPSR状态寄存器的值，保存到R0中。

1.  MSR：写状态存储器

可以将一个寄存器的内容或一个立即数传送到CPSR和SPSR；

MSR  CPSR_c,#0xD3;  

### 体系结构
<table>
<thead>
<tr>
<th>版本</th>
<th>结构</th>
</tr>
</thead>
<tbody>
<tr>
<td>ARM7</td>
<td>诺依曼结构</td>
</tr>
<tr>
<td>ARM9</td>
<td>哈佛体系结构</td>
</tr>
<tr>
<td>ARM11</td>
<td>ARMv6指令集体系结构</td>
</tr>
</tbody>
</table>

## 板级系统

### S3C2410X的存储系统特征

1.  支持数据存储大/小断选择（通过外部引脚进行选择）
2.  地址空间：具有8个存储体，每个存储体可达128MB，共计可达1GB
3.  对存储体的访问位数可变（8位/16位/32位）
4.  8个存储体中，Bank0~Bank5支持ROM,SRAM；Bank6、Bank7支持ROM、DRAM、SDRAM等。
5.  7个存储体的起始地址固定，一个存储体的起始地址可变

### I/O接口，I/O编址方式、数据传送

I/O接口：即输入输出接口，是微控制器同外界交互的重要通道。在主机和外围设备之间的信息交换中起桥梁和纽带作用。

#### 设置接口电路的必要性：

1.  解决主机CPU和外围设备之间的时序配合和通信联系问题；
2.  解决CPU和外围设备之间的数据格式转换和匹配问题；
3.  解决CPU的负载能力和外围设备端口选择问题。

#### I/O接口的编址方式：独立编址、统一编址

1.  独立编址：将存储器地址空间和I/O接口地址空间分开设置，互不影响。                         设有专门的输入指令和输出指令来完成I/O操作。
2.  统一编址：不区分存储器地址空间和I/O接口地址空间，把所有的I/O接口都当做是存储器的一个单元对待，每个接口芯片都安排一个或几个与存储器统一编号的地址号。

#### 数据传送

高阻输入，低挽输出，开漏输出

### 人机交互

#### LCD控制方式

LCD控制方式：总线驱动方式、控制器扫描方式

#### 键盘设计

键盘：是有若干个按键构成的开关矩阵，它是嵌入式系统中最简单的数字量输入设备，操作员通过键盘输入数据或命令，实现简单的人机通信。键盘的基本电路是一个接触开关，通、断两种状态分别表示0和1，微处理器可以很容易的检测到开关的闭合。

## 开发模式及工具

### 调试方法

调试方法：在线仿真器法、片上调试法、模拟器法

<table>
<thead>
<tr>
<th>名称</th>
<th>名称含义</th>
<th>区别</th>
<th>应用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>在线仿真器法</td>
<td>在线仿真器（ICE）是一种用于替代目标机上的CPU的设备。</td>
<td>效果最好、功能最全面、实时性最强的调试方法，但代价昂贵，通常仅在特殊情况下使用。</td>
<td>ICE调试方法特别适用于调试实时的应用系统、设备驱动程序以及对硬件进行  功能和性能的测试。</td>
</tr>
<tr>
<td>片上调试法</td>
<td>片上调试（OCD）是CPU芯片提供的一种调试软件的功能。</td>
<td>目前使用最广泛的的调试方法。不占用目标机资源，调试环境和最终的程序运行环境基本一致。支持软硬断点、跟踪、精确计量程序的执行时间、时序分析等功能。但实时性不如ICE强，不支持非干扰调试查询，CPU必须具有OCD功能。</td>
<td>OCD存在各种实现，标准不唯一。</td>
</tr>
<tr>
<td>模拟器法</td>
<td>模拟器是在宿主机上模拟出一个虚拟目标机的硬件环境，可以在这个虚拟的硬件环境上运行基于此硬件环境的程序甚至操作系统，得到在真实硬件上运行的结果，进而达到在宿主机上运行和调试嵌入式程序的目的。</td>
<td>最节约成本。可以在没有实际的目的机环境时开发其应用程序，并且在调试时可以利用宿主机的资源来提供更详细的错误诊断信息。但实时性差、不能模拟所有设备。</td>
<td>应用场合：可以在没有实际的目的机环境时开发其应用程序</td>
</tr>
</tbody>
</table>

### 进程和线程

#### 进程与线程的比较

*   进程是多道程序设计的产物，线程是将并行性引入到进程内部，线程被称为轻量级进程。
*   进程是操作系统调度程序执行和分配系统资源的基本单位。
*   线程是操作系统调度程序执行的最小单位，是进程内部的一个执行控制流。

不同方面：调度和切换、执行过程、拥有资源、系统开销

#### 结合具体 OS 分析

1.  嵌入式Linux操作系统的进程和线程：

    嵌入式Linux操作系统提供产生进程的机制。首先，使用系统调用fork() 复制当前进程的内容创建一个子进程，子进程与父进程的区别仅仅在于不同的PID、PPID和其他的一些资源。然后，执行函数exec() 读取可执行文件并将其载入地址空间开始运行。
嵌入式Linux操作系统也提供了创建线程的API函数pthread_create()，通常可以将所要传递给线程函数的参数写成一个结构体，传入到该函数中。

2.  WinCE操作系统的进程和线程：

    WinCE是基于优先级的抢占式多任务操作系统，一个应用程序对应一个进程，一个进程可以包含多个线程。进程本身不参加系统的调度，也没有优先级和上下文。进程创建时，会创建一个主线程作为该进程默认的执行本。

    在WinCE中，线程是系统调度的基本单位，有运行、挂起、睡眠、阻塞、终止五种状态。

3.  μC/OS-Ⅱ操作系统的进程

    μC/OS-Ⅱ操作系统运行时，实质上是一个进程，而所谓系统任务、用户任务都是运行于操作系统进程环境中的线程。

    μC/OS-Ⅱ操作系统提供了系统函数OSTaskCreate() 创建任务，每个任务有自己的堆栈空间、代码空间、但它们共享系统其他资源。

## μC/OS-II

### 特点

开源、可移植性好、可固话、可剪裁、占先式、多任务、可确定性、任务栈、系统服务、中断管理、稳定性与可靠性、易学易用、支持教学与科研

### 任务调度策略

P178为嵌入式任务管理   

1.  最短周期优先SBF
2.  优先级法
3.  轮转法
4.  多对轮转法和多级反馈队列法
5.  实时调度算法

P194为μC/OS-Ⅱ的任务管理

μC/OS-Ⅱ中有两种调度器：任务级调度器和中断级调度器。任务级的调度器由函数OSSched（）充当，中断级的调度器由函数OSIntExit（）充当。调度器的工作都是首先选择一个当前处于就绪态的优先级最高的任务，然后终止当前任务的运行，使新选出的任务投入运行。

### 表变量、组变量的认识

μC/OS-Ⅱ使用两个变量OSRdyGrp和OSRdyTbl[]表示任务的就绪情况，OSRdyGrp是一个INT8U型的整数，简称组变量；OSRdyTbl[]是具有8个元素，元素数据类型是INT8U的数组，简称表变量。
组变量特点：组变量是一个8位的无符号整数，取值范围从0~255，最多具有256个值。如果把组变量的每个取值n作为数组OSUnMapTbl[]的下标，组变量的值为n时所表示的具有最高优先级的任务所在的行号作为对应的数组的元素值。

通过查询组变量和表变量来确定处于就绪态的优先级最高的任务。

### OSMapTbl[],OSUnMapTbl[]

1.  OSMapTbl[]是一个为了加快运算速度而定义的数组，一共8个元素。

    下标与值的关系：表变量中的下标对应位置为1。例如OSMapTbl[0]=0b00000001；

2.  OSUnMapTbl[]中每个元素的值就是数组元素下标转化成二进制后，从低向高看第一个1所在的位的顺序号。

### 就绪操作的核心代码

就绪任务的登记：

    OSRdyGrp  <span class="string">|OSMapTbl[Prio &gt;&gt; 3];</span>
    OSRdyTbl[Prio &gt;&gt; <span class="number">3</span>]  <span class="string">| = OSMapTbl[Prio &amp; 0x07];</span>
    `</pre>

    任务的删除：

    <pre>`<span class="keyword">if</span>((<span class="constant">OSRdyTbl</span>[  prio <span class="prompt">&gt;&gt; </span><span class="number">3</span>]  &amp; = ~<span class="constant">OSMapTbl</span>[ prio  &amp; <span class="number">0x07</span> ] ) == <span class="number">0</span>)
    <span class="constant">OSRdyGrp</span>  &amp; =　~<span class="constant">OSMapTbl</span>[ prio  <span class="prompt">&gt;&gt; </span><span class="number">3</span>];
    `</pre>

    寻找高优先级任务的方法

    <pre>`<span class="setting">y = <span class="value">OSUnMapTbl[OSRdyGrp];</span></span>
    <span class="setting">prio= <span class="value">( y &lt;&lt; <span class="number">3</span>) + OSUnMapTbl [ OSRdyTbl [ y ] ];</span></span>

## μC/OS-II 扩展

### FS

μC/FS是一种几乎可以运行在所有介质上的基于FAT（文件分配表）的文件系统，前提是这种介质能提供基本的访问功能。μC/FS针对不同的设备，在速度、内存使用等方面进行了很好的优化，具有良好的性能。
μC/FS体系结构，由四个层次组成：

![](/2015/06/08/arm-overview/fs.jpg)

### GUI

嵌入式GUI的特点：具有较高的性能，可以满足基本的应用需求；运行时占用较少的资源，体积小；具有较高的可靠性；上层接口与硬件无关，易于剪裁，易于移植。

μC/GUI被设计成用于给使用一个图形LCD的任何应用程序提供一个高效率的，与处理器核LCD控制器无关的GUI。

## 应用

### 开发流程

*   系统需求分析
*   体系结构设计
*   软硬件及机械系统设计
*   系统集成
*   系统测试
*   最终产品